<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Step-by-step Walkthrough · WVZAnalysis.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">WVZAnalysis.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Introduction</a></li><li><a class="tocitem" href="../internalapis/">Internal APIs</a></li><li class="is-active"><a class="tocitem" href>Step-by-step Walkthrough</a><ul class="internal"><li><a class="tocitem" href="#Before-you-start"><span>Before you start</span></a></li><li class="toplevel"><a class="tocitem" href="#Step-1"><span>Step 1</span></a></li><li class="toplevel"><a class="tocitem" href="#Step-2"><span>Step 2</span></a></li><li class="toplevel"><a class="tocitem" href="#Step-3"><span>Step 3</span></a></li><li class="toplevel"><a class="tocitem" href="#Step-4"><span>Step 4</span></a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Step-by-step Walkthrough</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Step-by-step Walkthrough</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/Moelf/WVZAnalysis.jl/blob/master/docs/src/walkthrough.md#L" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Introduction-and-pre-requisite"><a class="docs-heading-anchor" href="#Introduction-and-pre-requisite">Introduction and pre-requisite</a><a id="Introduction-and-pre-requisite-1"></a><a class="docs-heading-anchor-permalink" href="#Introduction-and-pre-requisite" title="Permalink"></a></h1><p>The entire WVZAnalysis (4 lepton channel) can be break into rought 5 parts:</p><ol><li>Make flat <code>.arrow</code> files from &quot;nominal&quot; samples</li><li>Use <code>.arrow</code> files to train XGBoost models</li><li>Use XGBoost models to produce histograms that include all systematics variations (saved temporarily via <code>Serialization</code>. This step involves HTCondor (or maybe other job system)</li><li>Convert histograms to <code>.root</code> files via Python <code>uproot</code></li><li>Run fit with TRex-fitter (outside of this walkthrough)</li></ol><p>This Julia package is almost self-contained, certainly all of Julia parts should be exactly reproducible. But we will rely on <code>LCG</code> release for the three Python pkg (<code>uproot, hist, numpy</code>), and because Python importing rules, at step 4 you need to start Julia with an environment variable, as noted below.</p><h2 id="Before-you-start"><a class="docs-heading-anchor" href="#Before-you-start">Before you start</a><a id="Before-you-start-1"></a><a class="docs-heading-anchor-permalink" href="#Before-you-start" title="Permalink"></a></h2><p>We will assume you have access to LCG release via CVMFS, and use the <code>dev4</code> branch which contains Julia 1.9+:</p><pre><code class="language-bash hljs">source /cvmfs/sft.cern.ch/lcg/views/dev4/latest/x86_64-centos7-gcc11-opt/setup.sh</code></pre><p>You should also clone this repository and checkout the <code>refactor_Julia_v1p9</code> branch (or if this branch is merged, just whatever release tag you need):</p><pre><code class="language-bash hljs">git clone https://github.com/Moelf/WVZAnalysis.jl/
cd WVZAnalysis.jl
git checkout refactor_Julia_v1p9</code></pre><p>Finally, instantiate the exact Julia versions we used for this analysis:</p><pre><code class="language-bash hljs"># this is generally the command we need to use to start a Julia REPL
# `.` here is the root directory of this git repo
JULIA_CPU_TARGET=generic JULIA_CONDAPKG_BACKEND=Null julia --project=. 

]instantiate # when you press `]` the prompt should switch to `(WVZAnalysis) pkg&gt;`</code></pre><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>If you want to use LCG for all the Python stuff, remember to add this <code>JULIA_CONDAPKG_BACKEND=Null</code> which tells <code>PythonCall.jl</code> to not manage our Python environment!</p></div></div><h1 id="Step-1"><a class="docs-heading-anchor" href="#Step-1">Step 1</a><a id="Step-1-1"></a><a class="docs-heading-anchor-permalink" href="#Step-1" title="Permalink"></a></h1><pre><code class="language-julia hljs">using WVZAnalysis

foreach(ALL_TAGS) do tag
    arrow_main(tag; output_dir=&quot;/data/jiling/WVZ/v2.3-2023_06_06_arrow/&quot;);
end</code></pre><p>Remember to change <code>output_dir</code> to somewhere you have write access.</p><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>This assumes <code>WVZAnalysis.MINITREE_DIR</code> points to the data dir, on AF UChicago, all the minitree files are copied to <code>/data/jiling/WVZ/v2.3</code>, if you need to change this, run <code>WVZAnalysis.set_minitree_dir</code> and restart Julia session. This setting presists across Julia sessions via <code>Preference.jl</code>, the values are stored in the <code>LocalPreferences.toml</code> file.</p></div></div><h1 id="Step-2"><a class="docs-heading-anchor" href="#Step-2">Step 2</a><a id="Step-2-1"></a><a class="docs-heading-anchor-permalink" href="#Step-2" title="Permalink"></a></h1><p>Now that the arrow files are in place, we can train XGBoost, you really want to use GPU for this training, in the walkthrough, we will use AF UChicago&#39;s gpu node.</p><p>First we start an interactive condor job:</p><pre><code class="language-bash hljs">condor_submit -interactive config/interactive.sub</code></pre><p>Then once you&#39;re dropped onto remote worker, you need to re setup environment:</p><pre><code class="nohighlight hljs">source /cvmfs/sft.cern.ch/lcg/views/dev4/latest/x86_64-centos7-gcc11-opt/setup.sh

cd &lt;where you cloned WVZAnalysis.jl&gt;

JULIA_CPU_TARGET=generic JULIA_CONDAPKG_BACKEND=Null julia --project=./WVZXGBoostExt</code></pre><p>Then, we need to instantiate on this node because hardware has changed (we have a GPU now):</p><pre><code class="nohighlight hljs">]instantiate</code></pre><p>Finally, we can run our XGBoost training (remember to replace the paths):</p><pre><code class="language-julia hljs">using WVZXGBoostExt

df_all = WVZXGBoostExt.load_all_arrow(&quot;/data/jiling/WVZ/v2.3-2023_06_06_arrow/&quot;)
WVZXGBoostExt.train_and_log(df_all; output_dir = &quot;/data/jiling/WVZ/v2.3-2023_06_15_hists/&quot;, tree_method=&quot;gpu_hist&quot;)</code></pre><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>The <code>+queue=&quot;short&quot;</code> and <code>request_gpus=1</code> (in <code>interactive.sub</code>) are used by AF UChicago.</p></div></div><h1 id="Step-3"><a class="docs-heading-anchor" href="#Step-3">Step 3</a><a id="Step-3-1"></a><a class="docs-heading-anchor-permalink" href="#Step-3" title="Permalink"></a></h1><p>In this step, we use the cluster (HTCondor in this case) to run through all systematic variations:</p><p>But first, you need to point our package to the new location that stores the XGBoost models:</p><pre><code class="language-bash hljs">$ JULIA_CPU_TARGET=generic JULIA_CONDAPKG_BACKEND=Null julia --project=. -e &#39;using WVZAnalysis; WVZAnalysis.set_bdt_model_dir(&quot;/data/jiling/WVZ/v2.3-2023_06_15_hists/&quot;)&#39;</code></pre><p>Then start a new Julia session:</p><pre><code class="nohighlight hljs">$ JULIA_CPU_TARGET=generic JULIA_CONDAPKG_BACKEND=Null julia --project=.</code></pre><p>Then, we can schedule all the histogram making jobs:</p><pre><code class="language-julia hljs">using ClusterManagers, Distributed, WVZAnalysis

addprocs(HTCManager(100); extrajdl=[&quot;+queue=\&quot;short\&quot;&quot;], extraenv=[&quot;export JULIA_CPU_TARGET=generic&quot;], exeflags = `--project=$(Base.active_project()) -e &#39;include(&quot;/data/jiling/WVZ/init.jl&quot;)&#39;`);

@everywhere using WVZAnalysis</code></pre><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>We now request 100 jobs, and we no longer need gpu requirement since we&#39;re not training.  The <code>init.jl</code> fixes an issue where remote Julia workers sometimes can&#39;t find the correct network interface.</p></div></div><pre><code class="language-julia hljs">foreach([ALL_TAGS; &quot;Data&quot;]) do tag
    hist_main(tag; output_dir=&quot;/data/jiling/WVZ/v2.3-2023_06_15_hists/&quot;);
end</code></pre><p>You want to exit this Julia session after you&#39;re finished, which will also kill the condor jobs (unless you want to manually run <code>rmprocs()</code>)</p><h1 id="Step-4"><a class="docs-heading-anchor" href="#Step-4">Step 4</a><a id="Step-4-1"></a><a class="docs-heading-anchor-permalink" href="#Step-4" title="Permalink"></a></h1><p>In this last step, we will convert the output from last step into <code>.root</code> files, start a new Julia session if you exit the last one:</p><pre><code class="language-bash hljs">$ JULIA_CPU_TARGET=generic JULIA_CONDAPKG_BACKEND=Null julia --project=.</code></pre><p>and simply use the little Python &quot;extention&quot; package we wrote:</p><pre><code class="language-julia hljs">julia&gt; using WVZPythonExt

julia&gt; serial_to_root(&quot;/data/jiling/WVZ/v2.3-2023_06_15_hists/&quot;)

julia&gt; filter(endswith(&quot;root&quot;), readdir(&quot;/data/jiling/WVZ/v2.3-2023_06_12_hists/&quot;))
13-element Vector{String}:
 &quot;Data.root&quot;
 &quot;Others.root&quot;
 &quot;Signal.root&quot;
 &quot;VBS.root&quot;
 &quot;VH.root&quot;
 &quot;WZ.root&quot;
 &quot;ZZ.root&quot;
 &quot;Zgamma.root&quot;
 &quot;Zjets.root&quot;
 &quot;tWZ.root&quot;
 &quot;tZ.root&quot;
 &quot;ttZ.root&quot;
 &quot;ttbar.root&quot;</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../internalapis/">« Internal APIs</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Wednesday 5 July 2023 14:54">Wednesday 5 July 2023</span>. Using Julia version 1.9.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
